---
import type { ContactFormCardProps } from '../../types';

interface Props extends ContactFormCardProps {}

const { title, description, subjects } = Astro.props;

const STRAPI_URL = import.meta.env.STRAPI_URL || 'http://localhost:1337';
---

<article class="bg-white rounded-3xl shadow-lg p-6 flex flex-col gap-6">
  <div class="space-y-2">
    <h2 class="text-2xl font-semibold text-primary">{title}</h2>
    <p class="text-primary-text">{description}</p>
  </div>
  
  <!-- Success message -->
  <div 
    data-success-msg 
    class="hidden rounded-2xl bg-green-100 border border-green-300 text-green-800 px-4 py-3 text-sm"
  >
    Â¡Mensaje enviado exitosamente! Te responderemos pronto.
  </div>
  
  <!-- Error message -->
  <div 
    data-error-msg 
    class="hidden rounded-2xl bg-red-100 border border-red-300 text-red-800 px-4 py-3 text-sm"
  >
  </div>
  
  <form data-contact-form data-strapi-url={STRAPI_URL} class="flex flex-col gap-4">
    <div class="grid gap-4 md:grid-cols-2">
      <label class="flex flex-col gap-2 text-left">
        <span class="text-sm font-medium text-primary">Nombre completo</span>
        <input
          type="text"
          name="fullName"
          required
          class="rounded-2xl border border-primary/20 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary/40"
          placeholder="Maria Fernanda Perez"
        />
      </label>
      <label class="flex flex-col gap-2 text-left">
        <span class="text-sm font-medium text-primary">Correo electronico</span>
        <input
          type="email"
          name="email"
          required
          class="rounded-2xl border border-primary/20 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary/40"
          placeholder="correo@parroquia.org"
        />
      </label>
    </div>
    <label class="flex flex-col gap-2 text-left">
      <span class="text-sm font-medium text-primary">Asunto</span>
      <select
        name="subject"
        required
        class="rounded-2xl border border-primary/20 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary/40"
      >
        <option value="">Selecciona un motivo</option>
        {subjects.map((subject) => (
          <option value={subject.value}>{subject.value}</option>
        ))}
      </select>
    </label>
    <label class="flex flex-col gap-2 text-left">
      <span class="text-sm font-medium text-primary">Mensaje</span>
      <textarea
        name="message"
        rows="5"
        required
        class="rounded-2xl border border-primary/20 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary/40"
        placeholder="Cuentanos como podemos ayudarte"
      ></textarea>
    </label>
    <button
      type="submit"
      data-submit-btn
      class="w-full rounded-full bg-primary text-white font-semibold py-3 hover:bg-primary/90 transition disabled:opacity-50 disabled:cursor-not-allowed"
    >
      Enviar mensaje
    </button>
  </form>
</article>

<script>
  function initContactForm() {
    const form = document.querySelector('[data-contact-form]') as HTMLFormElement | null;
    if (!form) return;
    
    const strapiUrl = form.getAttribute('data-strapi-url') || '';
    const submitBtn = form.querySelector('[data-submit-btn]') as HTMLButtonElement | null;
    const successMsg = form.parentElement?.querySelector('[data-success-msg]') as HTMLElement | null;
    const errorMsg = form.parentElement?.querySelector('[data-error-msg]') as HTMLElement | null;
    
    if (!submitBtn || !successMsg || !errorMsg) return;
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Hide previous messages
      successMsg.classList.add('hidden');
      errorMsg.classList.add('hidden');
      
      // Get form data
      const formData = new FormData(form);
      const fullName = formData.get('fullName')?.toString().trim() || '';
      const email = formData.get('email')?.toString().trim() || '';
      const subject = formData.get('subject')?.toString().trim() || '';
      const message = formData.get('message')?.toString().trim() || '';
      
      // Validate required fields
      if (!fullName || !email || !subject || !message) {
        errorMsg.textContent = 'Por favor completa todos los campos.';
        errorMsg.classList.remove('hidden');
        return;
      }
      
      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        errorMsg.textContent = 'Por favor ingresa un correo electronico valido.';
        errorMsg.classList.remove('hidden');
        return;
      }
      
      // Show loading state
      submitBtn.disabled = true;
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Enviando...';
      
      try {
        const response = await fetch(`${strapiUrl}/api/contact-requests`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            data: { fullName, email, subject, message }
          }),
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('Strapi error:', errorData);
          throw new Error('Error al enviar el mensaje');
        }
        
        // Success - reset form and show success message
        form.reset();
        successMsg.classList.remove('hidden');
        
        // Scroll to success message
        successMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } catch (error) {
        console.error('Form submission error:', error);
        errorMsg.textContent = 'Hubo un error al enviar tu mensaje. Por favor intenta de nuevo.';
        errorMsg.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initContactForm);
  
  // Re-initialize on Astro page transitions (View Transitions API)
  document.addEventListener('astro:page-load', initContactForm);
</script>
