---
import { STRAPI_URL } from '../lib/strapi';

interface Props {
  title?: string;
  description?: string;
}

const {
  title = 'Suscríbete al boletín',
  description = 'Recibe en tu correo las últimas noticias, anuncios y testimonios de la comunidad.',
} = Astro.props;

const endpoint = `${STRAPI_URL}/api/news-letter-subscriptions`;
---

<section class="rounded-2xl p-6 text-primary-text shadow-lg">
  <div class="mb-5 flex flex-col gap-2">
    <h2 class="text-2xl font-semibold text-primary">{title}</h2>
    <p class="text-sm text-primary-text/80">{description}</p>
  </div>

  <form
    data-newsletter-form
    data-endpoint={endpoint}
    class="flex flex-col gap-3"
    aria-live="polite"
    novalidate
  >
    <label class="flex flex-col gap-2 text-sm font-medium text-primary">
      Correo electrónico
      <input
        type="email"
        name="email"
        required
        placeholder="tu-correo@ejemplo.com"
        class="w-full rounded-2xl border border-primary/20 bg-white/80 px-4 py-3 text-base text-primary-text placeholder:text-primary-text/40 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/30"
      />
    </label>

    <button
      type="submit"
      data-newsletter-submit
      class="inline-flex items-center justify-center rounded-2xl bg-primary px-5 py-3 text-base font-semibold text-white transition hover:bg-primary/90 disabled:cursor-not-allowed disabled:bg-primary/50"
    >
      Suscribirme
    </button>

    <p data-newsletter-message class="min-h-[1.5rem] text-sm font-medium"></p>
  </form>
</section>

<script type="module">
  const forms = document.querySelectorAll('[data-newsletter-form]');

  forms.forEach((form) => {
    if (form.dataset.bound === 'true') return;
    form.dataset.bound = 'true';

    const endpoint = form.dataset.endpoint;
    const input = form.querySelector('input[name="email"]');
    const messageNode = form.querySelector('[data-newsletter-message]');
    const submitBtn = form.querySelector('[data-newsletter-submit]');

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      if (!endpoint || !input || !submitBtn || !messageNode) return;

      const email = input.value.trim();
      if (!email) {
        messageNode.textContent = 'Por favor ingresa un correo válido.';
        messageNode.className = 'text-sm font-medium text-red-600 min-h-[1.5rem]';
        input.focus();
        return;
      }

      submitBtn.disabled = true;
      messageNode.textContent = 'Enviando…';
      messageNode.className = 'text-sm font-medium text-primary min-h-[1.5rem]';

      try {
        const payload = {
          data: {
            email,
            name: '',
            statusSub: 'active',
            subscribedAt: new Date().toISOString(),
            source: window.location.href,
          },
        };

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error('Error ' + response.status);
        }

        messageNode.textContent = '¡Gracias! Revisa tu correo para confirmar la suscripción.';
        messageNode.className = 'text-sm font-medium text-emerald-700 min-h-[1.5rem]';
        form.reset();
      } catch (error) {
        console.error('Newsletter subscription error', error);
        messageNode.textContent = 'No pudimos procesar tu solicitud. Intenta nuevamente.';
        messageNode.className = 'text-sm font-medium text-red-600 min-h-[1.5rem]';
      } finally {
        submitBtn.disabled = false;
      }
    });
  });
</script>
