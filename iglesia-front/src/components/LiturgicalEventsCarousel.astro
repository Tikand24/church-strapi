---
import type { LiturgicalEvent, LiturgicalWeekday } from '../types/liturgical-events';

interface Props {
  events: LiturgicalEvent[];
  initialIndex?: number;
}

const { events = [], initialIndex = 0 }: Props = Astro.props;

const weekdayOrder: LiturgicalWeekday[] = [
  'Lunes',
  'Martes',
  'Miercoles',
  'Jueves',
  'Viernes',
  'Sabado',
  'Domingo',
];

const colorThemes: Record<string, { chip: string }> = {
  verde: { chip: 'bg-gradient-to-r from-emerald-600 to-emerald-400 text-white' },
  morado: { chip: 'bg-gradient-to-r from-purple-700 to-purple-500 text-white' },
  rojo: { chip: 'bg-gradient-to-r from-rose-700 to-rose-500 text-white' },
  blanco: { chip: 'bg-gradient-to-r from-slate-200 to-slate-100 text-primary-text' },
  azul: { chip: 'bg-gradient-to-r from-sky-700 to-sky-500 text-white' },
  dorado: { chip: 'bg-gradient-to-r from-amber-600 to-amber-400 text-white' },
};

const normalizeColor = (color?: string) => color?.toLowerCase().trim() || 'verde';

const preprocessDescription = (description?: LiturgicalEvent['description']) => {
  if (!description || !Array.isArray(description)) return [];
  const result: string[] = [];
  const traverse = (nodes: NonNullable<LiturgicalEvent['description']>) => {
    nodes.forEach((node) => {
      if (node.type === 'text' && node.text) {
        result.push(node.text.trim());
      }
      if (node.children) {
        traverse(node.children);
      }
    });
  };
  traverse(description);
  return result.filter(Boolean);
};

const preparedEvents = events.map((event, index) => {
  const key = normalizeColor(event.color);
  return {
    ...event,
    times: preprocessDescription(event.description),
    theme: colorThemes[key] || colorThemes.verde,
    order: weekdayOrder.indexOf(event.eventDate),
    index,
  };
});
---

<section
  class="slider-liturgical-events relative flex flex-col overflow-hidden rounded-3xl border border-primary/10 bg-white shadow-xl"
  data-liturgical-slider
  data-initial-index={initialIndex}
>
  <header class="flex items-center justify-between px-6 pb-4 pt-6">
    <div>
      <h3 class="text-2xl font-bold text-primary-text">Calendario liturgico</h3>
    </div>
    <div class="flex gap-2">
      <button
        type="button"
        class="inline-flex size-10 items-center justify-center rounded-full border border-white/20 bg-white/10 text-primary-text transition-colors hover:bg-white/30 disabled:cursor-not-allowed disabled:opacity-40"
        data-prev
        aria-label="Evento anterior"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="size-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
        </svg>
      </button>
      <button
        type="button"
        class="inline-flex size-10 items-center justify-center rounded-full border border-white/20 bg-white/10 text-primary-text transition-colors hover:bg-white/30 disabled:cursor-not-allowed disabled:opacity-40"
        data-next
        aria-label="Evento siguiente"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="size-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
        </svg>
      </button>
    </div>
  </header>

  {preparedEvents.length === 0 ? (
    <div class="flex flex-col items-center justify-center gap-4 px-6 pb-10 text-center text-primary-text/70">
      <p class="text-lg font-semibold">Pronto compartiremos la agenda litúrgica de la semana.</p>
      <p class="text-sm">Vuelve en unos días para conocer las próximas celebraciones.</p>
    </div>
  ) : (
    <div class="relative transition-[height] duration-500 ease-out" data-slider-body>
      <ul class="h-full">
        {preparedEvents.map((event) => (
          <li
            class="absolute inset-0 flex flex-col justify-between rounded-[28px] border border-primary/10 bg-white p-6 text-primary-text opacity-0 transition-all duration-500 ease-out data-[active='true']:opacity-100 data-[active='true']:translate-y-0 translate-y-4"
            style={`--delay:${event.index * 50}ms;`}
            data-slide
            data-index={event.index}
            data-day-order={event.order}
            data-weekday={event.eventDate}
            data-color={normalizeColor(event.color)}
          >
            <div>
              <div class="mb-4 flex flex-col items-center gap-3">
                <span class="text-2xl font-bold text-primary">
                  {event.eventDate}
                </span>
                <span class={`rounded-full px-4 py-1 text-xs font-semibold uppercase tracking-[0.4em] ${event.theme.chip}`}>
                  {event.eventType}
                </span>
              </div>
              <h4 class="text-xl font-semibold leading-snug text-primary-text">{event.title}</h4>
              
              {event.location && (
                <p class="mt-1 text-base text-primary-text/80">{event.location}</p>
              )}
            </div>
            <div class="mt-6 rounded-2xl border border-primary/10 bg-primary/5 p-5">
              <p class="text-sm font-semibold uppercase tracking-[0.3em] text-primary-text/80">Horarios</p>
              {event.times.length > 0 ? (
                <ul class="mt-3 flex flex-wrap gap-2">
                  {event.times.map((time, tIndex) => (
                    <li class="rounded-full bg-white px-3 py-1 text-sm font-medium text-primary" data-time-index={tIndex}>
                      {time}
                    </li>
                  ))}
                </ul>
              ) : (
                <p class="mt-3 text-sm text-primary-text/70">Detalles próximamente.</p>
              )}
            </div>
          </li>
        ))}
      </ul>
      

      <div class="absolute inset-x-0 bottom-4 flex justify-center gap-2" aria-hidden="true">
        {preparedEvents.map((event) => (
          <span
            data-indicator
            data-index={event.index}
            class="h-1.5 w-6 rounded-full bg-primary/20 transition-all"
          ></span>
        ))}
      </div>
    </div>
    <div class="my-6 flex justify-center">
      <a
          href="#"
          class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold shadow-md hover:bg-primary/90 transition-all"
        >
          <span class="truncate">Ver calendario completo</span>
        </a>
    </div>
  )}

  <script>
    const slider = document.querySelector('.slider-liturgical-events ') as HTMLElement | null;
    if (slider) {
      const sliderBody = slider.querySelector('[data-slider-body]') as HTMLElement | null;
      const slides = Array.from(slider.querySelectorAll('[data-slide]')) as HTMLLIElement[];
      const indicators = Array.from(slider.querySelectorAll('[data-indicator]')) as HTMLSpanElement[];
      const prevBtn = slider.querySelector('[data-prev]') as HTMLButtonElement | null;
      const nextBtn = slider.querySelector('[data-next]') as HTMLButtonElement | null;
      const initialIndex = Number(slider.dataset.initialIndex || 0);
      let currentIndex = Math.min(Math.max(initialIndex, 0), slides.length - 1);

      const updateBodyHeight = () => {
        if (!sliderBody) return;
        const activeSlide = slides[currentIndex];
        if (!activeSlide) return;
        sliderBody.style.height = `${activeSlide.scrollHeight}px`;
      };

      const updateSlides = () => {
        slides.forEach((slide, index) => {
          slide.dataset.active = index === currentIndex ? 'true' : 'false';
          if (index === currentIndex) {
            slide.style.zIndex = '10';
            slide.style.opacity = '1';
            slide.style.transform = 'translateY(0) scale(1)';
          } else {
            slide.style.zIndex = '0';
            slide.style.opacity = '0';
            slide.style.transform = 'translateY(12px) scale(0.98)';
          }
        });
        indicators.forEach((indicator, index) => {
          indicator.classList.toggle('bg-primary', index === currentIndex);
          indicator.classList.toggle('bg-primary/20', index !== currentIndex);
          indicator.style.opacity = index === currentIndex ? '1' : '0.5';
        });
        if (prevBtn && nextBtn) {
          const hasMultiple = slides.length > 1;
          prevBtn.disabled = !hasMultiple;
          nextBtn.disabled = !hasMultiple;
        }
        updateBodyHeight();
      };

      const goTo = (index: number) => {
        if (slides.length === 0) return;
        const total = slides.length;
        currentIndex = (index + total) % total;
        updateSlides();
      };

      prevBtn?.addEventListener('click', () => goTo(currentIndex - 1));
      nextBtn?.addEventListener('click', () => goTo(currentIndex + 1));
      indicators.forEach((indicator) => {
        indicator.addEventListener('click', () => {
          const index = Number(indicator.dataset.index || 0);
          goTo(index);
        });
      });

      window.addEventListener('resize', () => {
        updateBodyHeight();
      });

      updateSlides();
    }
  </script>
</section>
